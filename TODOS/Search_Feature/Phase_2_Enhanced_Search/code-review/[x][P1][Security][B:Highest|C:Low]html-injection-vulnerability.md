# Fix HTML Injection Vulnerability in Search Highlighting

## Priority: P1 | Type: Security | Benefit: Highest | Complexity: Low

## Problem Description

The `highlightSearchTerm` function creates HTML without properly sanitizing the original text content, creating a potential XSS vulnerability. Currently, only the search term is escaped, but snippet titles containing HTML characters (`<script>`, `&`, etc.) will be interpreted as HTML when using `Text.RichText`.

**Attack Vector Example**:
```json
{
    "title": "<script>alert('xss')</script>Test",
    "content": "safe content"  
}
```

This would execute JavaScript when the snippet title is displayed with rich text formatting.

## Implementation Plan

1. **Add HTML escaping function** to OverlayWindow.qml
2. **Update highlightSearchTerm function** to sanitize all text content before HTML processing  
3. **Add error handling** for malformed regex patterns or edge cases
4. **Test with potentially malicious snippet titles** to verify fix

## File Locations

- `/home/jc/Dev/snippet-manager/ui/OverlayWindow.qml` (lines 274-283, 453-454)
  - Function: `highlightSearchTerm(text, searchTerm)`
  - Usage: Text component in snippet Repeater

## Success Criteria

- All user-provided text is HTML-escaped before rich text rendering
- Search highlighting still works correctly after escaping
- No JavaScript execution possible through snippet titles
- Error handling prevents crashes from edge cases
- Manual testing with HTML characters in snippet titles shows safe rendering

## Dependencies

None - this is a standalone security fix.

## Code Examples

**Current Vulnerable Code**:
```javascript
function highlightSearchTerm(text, searchTerm) {
    if (!searchTerm || searchTerm.length === 0) {
        return text  // ❌ Unescaped text in RichText context
    }
    
    const escapedTerm = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')
    const regex = new RegExp(`(${escapedTerm})`, 'gi')
    
    // ❌ Injects unescaped 'text' into HTML
    return text.replace(regex, `<span style="color: ${Constants.search.matchHighlightTextColor};">$1</span>`)
}
```

**Proposed Secure Implementation**:
```javascript
function escapeHtml(text) {
    return text.replace(/&/g, '&amp;')
              .replace(/</g, '&lt;')
              .replace(/>/g, '&gt;')
              .replace(/"/g, '&quot;')
              .replace(/'/g, '&#39;')
}

function highlightSearchTerm(text, searchTerm) {
    try {
        if (!text || typeof text !== 'string') return ""
        if (!searchTerm || searchTerm.length === 0) return escapeHtml(text)
        
        const escapedText = escapeHtml(text)
        const escapedTerm = escapeHtml(searchTerm).replace(/[.*+?^${}()|[\]\\]/g, '\\$&')
        
        if (escapedTerm.length === 0) return escapedText
        
        const regex = new RegExp(`(${escapedTerm})`, 'gi')
        return escapedText.replace(regex, `<span style="color: ${Constants.search.matchHighlightTextColor};">$1</span>`)
        
    } catch (error) {
        console.warn("⚠️ Highlighting failed:", error.message)
        return escapeHtml(text || "")
    }
}
```

## Reminder

When implementation is finished, update the filename prefix from `[ ]` to `[x]`.